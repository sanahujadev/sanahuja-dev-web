---
// src/components/ui/cards/BlogCard.astro
import Button from "../../ui/Button.astro";
import ChevronRight from "../../ui/icons/ChevronRight.astro";
import type { CollectionEntry } from "astro:content";
import type { HTMLAttributes } from "astro/types";
import OptimizedImage from "../../ui/OptimizedImage.astro";

interface Props extends HTMLAttributes<"article"> {
  post: CollectionEntry<"blog">;
  lang: "es" | "en";
}

const { post, lang, class: className, ...props } = Astro.props;
const { data } = post;

const formatDate = (date: Date | undefined, locale: string) => {
    if (!date) return "";
    return new Date(date).toLocaleDateString(locale === "es" ? "es-ES" : "en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};

// Función para determinar el color del badge según categoría
const getCategoryColor = (cat: string) => {
    // Normalizamos para manejar strings libres del MDX
    const normalized = cat?.toLowerCase() || "";
    if (normalized.includes('wpo')) return 'bg-primary-700 text-white shadow-primary-500/20';
    if (normalized.includes('seo')) return 'bg-secondary-600 text-white shadow-secondary-500/20';
    return 'bg-amber-700 text-white shadow-amber-500/20'; // Negocio/Otros
};

const date = data.publishedAt || data.pubDate;

const getBadge = (categoria: string, lang: "es" | "en") => {
  if (lang === "es") {
    if (categoria === "wpo") return "Velocidad";
    if (categoria === "seo-local") return "Visibilidad";
    return "Negocio";
  }

  if (lang === "en") {
    if (categoria === "wpo") return "Speed";
    if (categoria === "seo-local") return "Visibility";
    return "Business";
  }
  
  return ""
}
---

<article class:list={["group relative flex flex-col h-full bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden hover:border-primary-500/50 transition-all duration-300 hover:shadow-xl hover:shadow-primary-500/10", className]} {...props} data-category={data.category?.toLowerCase()}>
  
  {/* Imagen & Badges */}
  <div class="relative aspect-[16/9] overflow-hidden bg-neutral-800">
    {/* Usamos OptimizedImage si es nombre de archivo, o img normal si es URL completa */}
    {data.image?.url && !data.image.url.startsWith('http') ? (
        <OptimizedImage
            imageName={data.image.url} 
            basePath="sanahujadev" 
            alt={data.image.alt || ""}
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            width={400} 
            height={225} 
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
        />
    ) : (
        <img 
            src={data.image?.url || "/placeholder.svg"} 
            alt={data.image?.alt || ""}
            loading="lazy"
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
        />
    )}
    
    {/* Overlay Gradient */}
    <div class="absolute inset-0 bg-gradient-to-t from-neutral-900/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

    {/* Featured Badge - No disponible en schema actual, omitimos o usamos lógica custom */}
    
    {/* Category Badge */}
    {data.category && (
        <div class="absolute top-4 left-4 z-10">
        <span class={`px-3 py-1 text-xs font-semibold rounded-full shadow-lg backdrop-blur-sm ${getCategoryColor(data.category)}`}>
            {getBadge(data.category, lang)}
        </span>
        </div>
    )}
  </div>

  {/* Contenido */}
  <div class="flex flex-col flex-1 p-6">
    
    {/* Meta Data */}
    <div class="flex items-center gap-3 text-sm text-neutral-400 mb-3">
      <time datetime={date?.toISOString()} class="flex items-center">
        {formatDate(date, lang)}
      </time>
      {/* ReadTime pendiente de implementar cálculo real */}
    </div>

    {/* Título */}
    <h3 class="text-xl font-bold mb-3 leading-tight text-neutral-100 group-hover:text-primary-400 transition-colors">
      <a href={`/${lang}/blog/${post.slug}`} class="focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded-md">
        {data.title}
        <span class="absolute inset-0" aria-hidden="true"></span>
      </a>
    </h3>

    {/* Extracto (usamos description) */}
    <p class="text-neutral-400 mb-6 text-sm leading-relaxed line-clamp-3 flex-1">
        {data.description}
    </p>

    {/* Tags (Pills) */}
    <div class="flex flex-wrap gap-2 mb-6 relative z-10">
      {data.tags?.slice(0, 3).map((tag) => (
        <span class="px-2 py-1 bg-neutral-800 border border-neutral-700 text-neutral-400 text-xs rounded transition-colors hover:border-neutral-500">
          #{tag}
        </span>
      ))}
    </div>

    {/* Footer: Autor & Link Icon */}
    <div class="flex items-center justify-between pt-4 border-t border-neutral-800 mt-auto relative z-10">
      <div class="flex items-center gap-3">
        {/* Avatar simplificado por ahora, idealmente usar OptimizedImage también */}
        <div class="w-9 h-9 rounded-full overflow-hidden bg-neutral-800 ring-2 ring-neutral-800">
             {data.author?.avatar && !data.author.avatar.startsWith('http') ? (
                <OptimizedImage
                    imageName={data.author.avatar}
                    basePath="sanahujadev"
                    alt={data.author.name || ""}
                    sizes="(max-width: 400px) 100vw, (max-width: 600px) 50vw, 33vw"
                    width={36}
                    height={36}
                    class="w-full h-full object-cover"
                />
             ) : (
                <img src="/placeholder.svg" alt="" class="w-full h-full object-cover" />
             )}
        </div>
        
        <div class="leading-none">
          <p class="text-sm font-semibold text-neutral-200 mb-1">{data.author?.name}</p>
          <p class="text-[10px] uppercase tracking-wide text-neutral-400">{data.author?.role}</p>
        </div>
      </div>

      <div class="w-8 h-8 flex items-center justify-center rounded-full bg-neutral-800 text-neutral-400 group-hover:bg-primary-500 group-hover:text-white transition-colors duration-300">
        <ChevronRight class="w-4 h-4" />
      </div>
    </div>
  </div>
</article>
---
import Button from "../ui/Button.astro";
import ShieldCheck from "../ui/icons/ShieldCheck.astro";
import FormErrorIcon from "../ui/FormErrorIcon.astro"; // Import the error icon
import { API_URL, API_KEY, PUBLIC_TURNSTILE_SITE_KEY } from "astro:env/client";

interface Props {
  copy: {
    title: string;
    description: string;
    placeholder: string;
    button: string;
    disclaimer: string;
    consentText: string;
    privacyLinkText: string;
    consentEnd: string;
    successTitle: string;
    successMessage: string;
    genericErrorMessage: string;
    serverErrorMessage: string;
  };
  lang?: "es" | "en";
}

const { copy, lang = "es" } = Astro.props;

const privacyUrl = lang === "es" ? "/es/politica-de-privacidad" : "/en/privacy-policy";
---

<div class="relative z-10 max-w-3xl mx-auto text-center">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-secondary-500/10 border border-secondary-500/20 rounded-full mb-8">
        <ShieldCheck class="w-8 h-8 text-secondary-400" />
    </div>

    <h2 class="text-3xl md:text-4xl font-bold mb-6 text-white tracking-tight">{copy.title}</h2>
    <p class="text-neutral-400 mb-10 text-lg max-w-xl mx-auto">
        {copy.description}
    </p>

    <form 
        id="newsletter-form"
        class="flex flex-col gap-4 max-w-lg mx-auto mb-6 text-left"
        data-newsletter-form
        data-api-url={API_URL}
        data-api-key={API_KEY}
        data-turnstile-site-key={PUBLIC_TURNSTILE_SITE_KEY}
        novalidate
    >
        {/* Server Error Message */}
        <div id="server-error" class="hidden p-3 mb-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm text-center" role="alert">
            {copy.serverErrorMessage}
        </div>

        {/* Honeypot */}
        <input type="text" name="nickname" class="hidden" autocomplete="off" />

        <div class="flex flex-col sm:flex-row gap-4 items-start">
            {/* Email Input Wrapper */}
            <div class="flex-1 w-full relative">
                <div class="relative">
                    <input
                        type="email"
                        name="email"
                        id="newsletter-email"
                        placeholder={copy.placeholder}
                        required
                        aria-label={lang === 'es' ? "Email para newsletter" : "Newsletter email"}
                        class="w-full px-5 py-3 bg-neutral-950 border border-neutral-700 rounded-lg text-neutral-100 placeholder-neutral-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-all aria-[invalid=true]:border-red-500"
                    />
                    <FormErrorIcon
                        id="email-error-icon"
                        class="absolute inset-y-0 right-0 flex items-center pr-3"
                    />
                </div>
                <span
                    id="email-error"
                    role="alert"
                    class="hidden text-red-400 text-xs mt-1 absolute left-0 -bottom-5 flex items-center gap-1"
                >
                    {copy.genericErrorMessage}
                </span>
            </div>

            {/* Submit Button */}
            <div class="w-full sm:w-auto mt-2">
                <Button
                    type="submit"
                    variant="default"
                    class="whitespace-nowrap shadow-lg shadow-primary-500/20 cursor-pointer w-full"
                >
                    {copy.button}
                </Button>
            </div>
        </div>

        {/* Consent Checkbox */}
        <div class="flex flex-col">
            <div class="flex items-start gap-3 mt-2 relative">
                <div class="flex items-center h-5 relative">
                    <input
                        id="newsletter-consent"
                        name="consent"
                        type="checkbox"
                        required
                        class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-neutral-700 rounded bg-neutral-800 aria-[invalid=true]:border-red-500"
                    />
                    
                </div>
                <label for="newsletter-consent" class="text-sm text-neutral-400">
                    {copy.consentText} <a href={privacyUrl} class="text-primary-400 underline">{copy.privacyLinkText}</a> {copy.consentEnd}
                    <FormErrorIcon
                        id="consent-error-icon"
                        class="absolute right-4 top-0 md:right-12"
                    />
                </label>
            </div>
            <span
                id="consent-error"
                role="alert"
                class="hidden text-red-400 text-xs mt-1 flex items-center gap-1"
            >
                {copy.genericErrorMessage}
            </span>
        </div>

        {/* Turnstile */}
        <div id="turnstile-widget" class="flex justify-center mt-2"></div>
    </form>
    
    <div data-testid="success-message" class="hidden p-6 bg-green-500/10 border border-green-500/20 rounded-xl">
        <h3 class="text-xl font-bold text-green-400 mb-2">{copy.successTitle}</h3>
        <p class="text-neutral-300">{copy.successMessage}</p>
    </div>

    <p class="text-xs text-neutral-400 flex items-center justify-center gap-2 mt-4">
        <ShieldCheck class="w-3 h-3" />
        {copy.disclaimer}
    </p>
</div>

<script>
    import { NewsletterForm } from "../../scripts/newsletter/NewsletterForm";

    const MAX_RETRIES = 10;
    let retries = 0;

    function initializeForm() {
        const form = document.getElementById('newsletter-form') as HTMLFormElement;
        
        if (!form || (form as any)._newsletterInitialized) {
            return;
        }

        try {
            new NewsletterForm(form);
            (form as any)._newsletterInitialized = true;
            retries = 0;
        } catch (error) {
            console.error("Error initializing NewsletterForm:", error);
        }
    }

    function startPolling() {
        if (document.readyState !== "loading") {
            initializeForm();
        } else {
            retries++;
            if (retries < MAX_RETRIES) {
                setTimeout(startPolling, 300);
            }
        }
    }

    startPolling();
    document.addEventListener('astro:page-load', startPolling);
</script>
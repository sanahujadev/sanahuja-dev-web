---
// src/components/pages/LandingContacto.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import Button from "../../components/ui/Button.astro";
import Badge from "../../components/ui/Badge.astro";
import ChevronDown from "../../components/ui/icons/ChevronDown.astro";
import ChevronRight from "../../components/ui/icons/ChevronRight.astro";
import LayoutIcon from "../../components/ui/icons/LayoutIcon.astro";
import Package from "../../components/ui/icons/Package.astro";
import Shield from "../../components/ui/icons/Shield.astro";
import HelpCircle from "../../components/ui/icons/HelpCircle.astro";
import InformationCircle from "../../components/ui/icons/InformationCircle.astro";

import type { ContactoCopy } from "../../i18n/utils";

interface Props {
  copy: ContactoCopy;
  alternateUrl: string;
  schema: Record<string, any>;
}

const { copy, alternateUrl, schema } = Astro.props;
const { copy: t, lang, metadata } = copy;

// Variables dummy para que el componente compile en Astro estático
// TODO: Implementar lógica de interactividad real con Preact/React o Vanilla JS
const openStep = 1;
const formData = {
  name: "",
  email: "",
  message_basic: "",
  goal: "",
  timeline: "",
  budget_range: "",
};

// Type narrowing para campos con options
const projectTypeField = t.formUI.steps[1].fields[0];
const projectTypes =
  "options" in projectTypeField ? projectTypeField.options : [];

const techStatusField = t.formUI.steps[1].fields[1];
const techStatusOptions =
  "options" in techStatusField ? techStatusField.options : [];

// Icon map
const iconMap: Record<string, any> = {
  Layout: LayoutIcon,
  Package: Package,
  Shield: Shield,
  HelpCircle: HelpCircle,
};
---

<BaseLayout lang={lang as "es" | "en"} alternateUrl={alternateUrl}>
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(schema)}
    slot="json-ld"
  />
  <Fragment slot="head">
    <title>{metadata.title}</title>
    <meta name="description" content={metadata.description} />
  </Fragment>
  <main>
    {/* Hero */}
    <section id="hero">
      <h1>
        {t.hero.h1}
      </h1>
      <p>{t.hero.subtitle}</p>
      <p>
        {t.hero.intro}
      </p>
    </section>

    {/* Form */}
    <form id="contact-form">
      {/* Step 1: Identidad */}
      <section id="step_1_identity">
        <button type="button">
          <div>
            <div>01</div>
            <h3>{t.formUI.steps[0].title}</h3>
          </div>
          <ChevronDown />
        </button>

        {
          /* Renderizado siempre visible para SEO y porque la lógica JS no funciona en Astro estático */
        }
        <div>
          <div>
            <label>
              {t.formUI.steps[0].fields[0].label}
              <span>*</span>
            </label>
            <input
              name="name"
              type="text"
              required
              placeholder="Tu nombre completo"
            />
          </div>

          <div>
            <label>
              {t.formUI.steps[0].fields[1].label}
              <span>*</span>
            </label>
            <input
              name="email"
              type="email"
              required
              placeholder="tu@email.com"
            />
          </div>

          <div>
            <label>
              {t.formUI.steps[0].fields[2].label}
              <span>*</span>
            </label>
            <textarea
              name="message_basic"
              required
              rows="4"
              placeholder="Cuéntame qué necesitas..."></textarea>
          </div>

          {/* Accordion Trigger Text */}
          <div>
            <p>
              {t.formUI.steps[0].accordionText}
            </p>
            <button type="button">
              <span
                >{
                  "accordionButton" in t.formUI.steps[0]
                    ? t.formUI.steps[0].accordionButton
                    : "Desplegar"
                }</span
              >
              <ChevronRight />
            </button>
          </div>
        </div>
      </section>

      {/* Step 2: Alcance */}
      <section id="step_2_scope">
        <Button type="button">
          <div>
            <div>02</div>
            <h3>{t.formUI.steps[1].title}</h3>
          </div>
          <ChevronDown />
        </Button>

        <div>
          {/* Project Type Cards */}
          <div>
            <label>{t.formUI.steps[1].fields[0].label}</label>
            <div>
              {
                projectTypes &&
                  projectTypes.map((type) => {
                    const iconName =
                      "icon" in type ? (type as any).icon : "HelpCircle";
                    const IconComponent = iconMap[iconName || "HelpCircle"];
                    return (
                      <label>
                        <input
                          type="radio"
                          name="project_type"
                          value={type.value}
                          class="sr-only"
                        />
                        <div>
                          <div>{IconComponent && <IconComponent />}</div>
                          <span>{type.label}</span>
                        </div>
                      </label>
                    );
                  })
              }
            </div>
          </div>

          {/* Tech Status Pills */}
          <div>
            <label>{t.formUI.steps[1].fields[1].label}</label>
            <div>
              {
                techStatusOptions &&
                  techStatusOptions.map((option) => (
                    <label>
                      <input
                        type="radio"
                        name="tech_status"
                        value={option.value}
                        class="sr-only"
                      />
                      <span>{option.label}</span>
                    </label>
                  ))
              }
            </div>
          </div>

          {/* Accordion Trigger Text */}
          <div>
            <p>
              {t.formUI.steps[1].accordionText}
            </p>
            <button type="button">
              <span
                >{
                  "accordionButton" in t.formUI.steps[1]
                    ? t.formUI.steps[1].accordionButton
                    : "Desplegar"
                }</span
              >
              <ChevronRight />
            </button>
          </div>
        </div>
      </section>

      {/* Step 3: Viabilidad */}
      <section id="step_3_viability">
        <Button type="button">
          <div>
            <div>03</div>
            <h3>{t.formUI.steps[2].title}</h3>
          </div>
          <ChevronDown />
        </Button>

        <div>
          <div>
            <label>{t.formUI.steps[2].fields[0].label}</label>
            {
              (() => {
                const goalField = t.formUI.steps[2].fields[0];
                const placeholder =
                  "placeholder" in goalField ? goalField.placeholder : "";
                return (
                  <input type="text" name="goal" placeholder={placeholder} />
                );
              })()
            }
          </div>

          <div>
            <label>{t.formUI.steps[2].fields[1].label}</label>
            <select name="timeline">
              {
                (() => {
                  const timelineField = t.formUI.steps[2].fields[1];
                  const placeholder =
                    "placeholder" in timelineField
                      ? timelineField.placeholder
                      : "Selecciona";
                  return <option value="">{placeholder}</option>;
                })()
              }
              {
                (() => {
                  const timelineField = t.formUI.steps[2].fields[1];
                  const options =
                    "options" in timelineField ? timelineField.options : [];
                  return options?.map((opt) => (
                    <option value={opt.value}>{opt.label}</option>
                  ));
                })()
              }
            </select>
          </div>

          <div>
            <label>{t.formUI.steps[2].fields[2].label}</label>
            {
              (() => {
                const budgetField = t.formUI.steps[2].fields[2];
                const description =
                  "description" in budgetField ? budgetField.description : "";
                return <p>{description}</p>;
              })()
            }
            <select name="budget_range">
              {
                (() => {
                  const budgetField = t.formUI.steps[2].fields[2];
                  const placeholder =
                    "placeholder" in budgetField
                      ? budgetField.placeholder
                      : "Selecciona";
                  return <option value="">{placeholder}</option>;
                })()
              }
              {
                (() => {
                  const budgetField = t.formUI.steps[2].fields[2];
                  const options =
                    "options" in budgetField ? budgetField.options : [];
                  return options?.map((opt) => (
                    <option value={opt.value}>{opt.label}</option>
                  ));
                })()
              }
            </select>
          </div>
        </div>
      </section>

      {/* Ansiolítico Section */}
      <section>
        <div>
          <div>
            <InformationCircle />
          </div>
          <div>
            <p>
              {t.formUI.ansiolitico.text}
            </p>
            <Button href={t.formUI.ansiolitico.privacyLink} target="_self">
              <span
                >{
                  "privacyButton" in t.formUI.ansiolitico
                    ? t.formUI.ansiolitico.privacyButton
                    : "Privacidad"
                }</span
              >
              <ChevronRight />
            </Button>
          </div>
        </div>
      </section>

      {/* Submit Button */}
      <section>
        <Button type="submit">
          {t.formUI.config.fullSubmitLabel}
        </Button>
        <p>{t.formUI.config.seoKeyPhrase}</p>
      </section>
    </form>
  </main>
  <script is:inline>
    const form = document.getElementById("contact-form");
    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log("Form Data:", data);
        window.location.href = "/es/gracias-proyecto";
      });
    }
  </script>
</BaseLayout>

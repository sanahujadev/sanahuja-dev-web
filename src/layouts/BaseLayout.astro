---
// src/layouts/BaseLayout.astro
import { ClientRouter } from "astro:transitions";
import { AstroFont } from "astro-font";
import AppHeader from "../components/AppHeader.astro";
import "../styles/global.css";
// import criticalCSS from '../styles/critical-inline.css?raw';
import t_header_es from "../i18n/es/componentes/header.json" with {
  type: "json",
};
import t_header_en from "../i18n/en/componentes/header.json" with {
  type: "json",
};
import t_footer_es from "../i18n/es/componentes/footer.json" with {
  type: "json",
};
import t_footer_en from "../i18n/en/componentes/footer.json" with {
  type: "json",
};
import cookieConsent_es from "../i18n/es/legal/cookie-consent.json" with {
  type: "json",
};
import cookieConsent_en from "../i18n/en/legal/cookie-consent.json" with {
  type: "json",
};
import AppFooter from "../components/AppFooter.astro";

type Props = {
  lang?: "es" | "en";
  alternateUrl?: string;
  disableTransitions?: boolean; // <-- Control granular
  isConversionPage?: boolean; // <-- Marca páginas críticas
};

// import type { CookieConsentType } from '../i18n/utils'; // <-- Aún no existe
const {
  lang = "es",
  alternateUrl,
  disableTransitions = false,
  isConversionPage = false,
} = Astro.props;
const GTM_ID = import.meta.env.PUBLIC_GTM_ID;

// ¡LÓGICA DE REFACTOR CORREGIDA!
const siteURL = Astro.site; // <-- ¡Esto SÍ es https://sanahuja.dev!
const pathName = Astro.url.pathname; // <-- Esto SÍ es /es/servicios/diseno-web-tenerife

// ¡Construimos la URL canónica de PRODUCCIÓN!
const canonicalURL = new URL(pathName, siteURL).href;

const alternateLang = pathName.substring(1, 3) === "es" ? "en" : "es";

const t_header = lang === "es" ? t_header_es : t_header_en;
const t_footer = lang === "es" ? t_footer_es : t_footer_en;
const cookieConsent = lang === "es" ? cookieConsent_es : cookieConsent_en;
---

<!DOCTYPE html>
<html lang={lang} class="dark scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        
        <!-- Favicons: Google loves raster for SERP, SVG for sharpness -->
        <link rel="icon" type="image/svg+xml" href={new URL("/favicon.svg", Astro.site).href} />
        <link rel="icon" type="image/png" sizes="32x32" href={new URL("/favicon-32.png", Astro.site).href} />
        <link rel="icon" type="image/png" sizes="48x48" href={new URL("/favicon-48.png", Astro.site).href} />
        <link rel="icon" type="image/png" sizes="192x192" href={new URL("/favicon-192.png", Astro.site).href} />
        <link rel="apple-touch-icon" href={new URL("/apple-touch-icon.png", Astro.site).href} />
        <link rel="icon" href={new URL("/favicon.ico", Astro.site).href} sizes="32x32" />

        <slot name="head" />
        <!-- Canonical y alternates -->
        <link rel="canonical" href={canonicalURL} />
        {alternateUrl && <link rel="alternate" hreflang={alternateLang} href={alternateUrl} />}

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url.href} />
        <meta property="og:image" content={new URL("/og-image.jpeg", Astro.site).href} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url.href} />
        <meta property="twitter:image" content={new URL("/og-image.jpeg", Astro.site).href} />

        <slot name="json-ld" />

        <AstroFont
            config={[{
                name: "Montserrat", 
                display: "swap",
                selector: "html",
                fallback: "sans-serif",
                preload: true,
                src: [
                    { style: 'normal', weight: '400', path: '/fonts/montserrat-latin-400.woff2' },
                    { style: 'normal', weight: '500', path: '/fonts/montserrat-latin-500.woff2' },
                    { style: 'normal', weight: '600', path: '/fonts/montserrat-latin-600.woff2' },
                    { style: 'normal', weight: '700', path: '/fonts/montserrat-latin-700.woff2' },
                    { style: 'normal', weight: '800', path: '/fonts/montserrat-latin-800.woff2' },
                ],
            }]}
        />

        <!-- CRÍTICO 2: View Transitions con control granular -->
        {!disableTransitions && <ClientRouter fallback="none" />}

        <!-- Prefetch de páginas críticas del funnel (solo si NO es página de conversión) -->
        {!isConversionPage && (
          <>
            <link rel="prefetch" href={lang === 'es' ? '/es/contacto' : '/en/contact'} />
            <link rel="prefetch" href={lang === 'es' ? '/es/servicios' : '/en/services'} />
          </>
        )}
    </head>
    
    <body class="font-sans bg-neutral-900 text-neutral-200 antialiased">
        <script is:inline define:vars={{ GTM_ID, cookieConsent, lang }}>
            window.__GTM_ID__ = GTM_ID;
            window.__CONSENT_CONFIG__ = { lang, translations: cookieConsent };
        </script>
        <script src="../scripts/cookie-consent/gtag-stub.ts"></script>
        <script src="../scripts/cookie-consent/init.ts"></script>
        <AppHeader t={t_header} lang={lang} alternateUrl={alternateUrl} />
          <slot />
        <AppFooter t={t_footer} lang={lang} />
    </body>
</html>